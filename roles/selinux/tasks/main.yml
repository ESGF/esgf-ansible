
- name: Install libselinux-python
  package:
    name: libselinux-python

- name: Disable SELinux
  selinux:
    state: disabled
  register: selinux_result

- name: Install firewalld
  when: is_7 and (configure_centos7_firewalld is not defined or configure_centos7_firewalld)
  package:
    name: firewalld

- name: Enable firewalld
  when: is_7 and (configure_centos7_firewalld is not defined or configure_centos7_firewalld)
  service:
    name: firewalld
    enabled: yes
  register: firewalld_enabled

- name: Determine if a reboot should occur
  set_fact:
    should_reboot: (selinux_result.reboot_required or (is_7 and firewalld_enabled is defined and firewalld_enabled is changed))

- name: Pause for reboot confirmation
  when: should_reboot and (prompt_reboot is not defined or prompt_reboot)
  pause:
    prompt: Hit enter to confirm {{ ansible_fqdn }} reboot.
        Use 'ctrl+c' then 'a' to abort.
        If this is a local deployment and a reboot is confirmed, the deployment will need to be restarted,
        otherwise the deployment will continue automatically once the reboot is complete.

- name: Reboot {{ ansible_fqdn }} using a 15 minute timeout
  when: should_reboot
  reboot:
    reboot_timeout: 900 # 15 minutes
  register: reboot_result

- debug:
    msg: "{{ ansible_fqdn }} rebooted in {{ reboot_result.elapsed }} seconds"
  when: should_reboot
