# Ensure httpd Webserver is installed
- name: Ensure the apache webserver installed
  package:
    name:
      - "{{ pkgs.apache }}"
      - "mod_ssl"

# Begin setting up certificates for httpd
- name: Create cert dir
  file:
    path: "{{ httpd.cert_dir }}"
    state: directory

- name: Get Trusted Certificates
  when: trusted_certs is not defined
  get_url:
    url: "{{ httpd.trusted_ca.url }}"
    dest: "{{ httpd.cabundle }}"

- name: Copy {{ trusted_certs }} into place
  when: trusted_certs is defined
  get_url:
    url: "{{ trusted_certs }}"
    dest: "{{ httpd.cabundle }}"

# Get a cert from LetsEncrypt if credentials are not provided
- name: Install HTTP Config
  template:
    src: esgf-httpd.conf.j2
    dest: /etc/httpd/conf/httpd.conf

- name: Install LetsEncrypt Certs
  when: hostkey_src is not defined
  import_tasks: letsencrypt.yml

# Copy credentials into place if provided
- name: Copy {{ hostkey }} into place
  when: hostkey_src is defined
  copy:
    src: "{{ hostkey_src }}"
    dest: "{{ httpd.hostkey }}"

- name: Copy {{ hostcert }} into place
  when: hostcert_src is defined
  copy:
    src: "{{ hostcert_src }}"
    dest: "{{ httpd.hostcert }}"

- name: Copy {{ cachain }} into place
  when: cachain_src is defined
  copy:
    src: "{{ cachain_src }}"
    dest: "{{ httpd.cachain }}"

- name: Install HTTPS config
  template:
    src: "esgf-httpd.ssl.conf.j2"
    dest: "/etc/httpd/conf/httpd.ssl.conf"
#   notify:
#     - restart httpd